name: Build Debian Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          brew install dpkg ldid
      
      - name: Build app
        run: |
          xcodebuild archive \
            -project JailbreakDetector.xcodeproj \
            -scheme JailbreakDetector \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/JailbreakDetector.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_ENTITLEMENTS="JailbreakDetector/JailbreakDetector/JailbreakDetector.entitlements"
      
      - name: Fake sign with ldid
        run: |
          # Find the app binary
          APP_PATH="build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app"
          BINARY="$APP_PATH/JailbreakDetectorApp"
          
          # 1. Sign App Extensions (PlugIns) separately FIRST
          if [ -d "$APP_PATH/PlugIns" ]; then
            echo "ðŸ”Œ Signing App Extensions..."
            for EXT in "$APP_PATH/PlugIns"/*.appex; do
              if [ -d "$EXT" ]; then
                EXT_BINARY="$EXT/$(basename "$EXT" .appex)"
                EXT_NAME="$(basename "$EXT" .appex)"
                echo "   - Signing extension: $EXT_NAME"
                
                # Check if it's the Widget and use specific entitlements
                if [[ "$EXT_NAME" == "JailbreakWidget" ]]; then
                   ldid -SJailbreakDetector/JailbreakWidget/JailbreakWidget.entitlements "$EXT_BINARY"
                else
                   # Fallback for other extensions
                   ldid -S "$EXT_BINARY"
                fi
              fi
            done
          else
             echo "âš ï¸ No PlugIns directory found - Widget might not be built"
             # List contents to debug
             ls -R "$APP_PATH"
          fi

          # 2. Fake sign Main App with entitlements
          echo "ðŸ“± Signing Main App..."
          ldid -SJailbreakDetector/JailbreakDetector/JailbreakDetector.entitlements "$BINARY"
          
          echo "âœ… Fake signed app and extensions with ldid"
          ldid -e "$BINARY"
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create .deb packages for both architectures
        run: |
          # Build for iphoneos-arm
          mkdir -p package-arm/DEBIAN
          mkdir -p package-arm/Applications
          cp -R build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app \
            package-arm/Applications/JailbreakDetector.app
          
          cat > package-arm/DEBIAN/control << EOF
          Package: com.security.jailbreakdetector
          Name: Jailbreak Detector
          Version: ${{ steps.version.outputs.VERSION }}
          Architecture: iphoneos-arm
          Description: Advanced jailbreak detection with 8 techniques (OWASP MSTG compliant)
          Homepage: https://github.com/betillogalvanfbc/jailbreakdetection
          Maintainer: Developer
          Author: Developer
          Section: Security
          Depends: firmware (>= 16.0)
          EOF
          
          cat > package-arm/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          uicache -a
          exit 0
          EOF
          chmod 755 package-arm/DEBIAN/postinst
          
          # Build for iphoneos-arm64
          mkdir -p package-arm64/DEBIAN
          mkdir -p package-arm64/Applications
          cp -R build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app \
            package-arm64/Applications/JailbreakDetector.app
          
          cat > package-arm64/DEBIAN/control << EOF
          Package: com.security.jailbreakdetector
          Name: Jailbreak Detector
          Version: ${{ steps.version.outputs.VERSION }}
          Architecture: iphoneos-arm64
          Description: Advanced jailbreak detection with 8 techniques (OWASP MSTG compliant)
          Homepage: https://github.com/betillogalvanfbc/jailbreakdetection
          Maintainer: Developer
          Author: Developer
          Section: Security
          Depends: firmware (>= 16.0)
          EOF
          
          cat > package-arm64/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          uicache -a
          exit 0
          EOF
          chmod 755 package-arm64/DEBIAN/postinst
      
      - name: Build .deb packages
        run: |
          # Build iphoneos-arm
          dpkg-deb -b package-arm jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb
          echo "=== iphoneos-arm .deb info ==="
          dpkg-deb -I jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb
          
          # Build iphoneos-arm64
          dpkg-deb -b package-arm64 jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb
          echo "=== iphoneos-arm64 .deb info ==="
          dpkg-deb -I jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb
      
      - name: Wait for Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for release v${{ steps.version.outputs.VERSION }} to be created..."
          for i in {1..30}; do
            if gh release view v${{ steps.version.outputs.VERSION }} >/dev/null 2>&1; then
              echo "âœ… Release found!"
              exit 0
            fi
            echo "Attempt $i: Release not found yet. Waiting 10s..."
            sleep 10
          done
          echo "âŒ Release was not created in time."
          exit 1

      - name: Upload both .deb packages to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ steps.version.outputs.VERSION }} \
            jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb \
            jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb \
            --clobber

      - name: Update Cydia Repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Checkout gh-pages branch to 'repo' directory
          git clone --branch gh-pages --depth 1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git repo
          
          # Copy new debs
          mkdir -p repo/debs
          cp *.deb repo/debs/
          
          # Generate Packages
          cd repo
          dpkg-scanpackages -m . /dev/null > Packages
          
          # Compress
          rm -f Packages.gz Packages.bz2
          gzip -k -f Packages
          bzip2 -k -f Packages
          
          # Update Release file
          cat > Release << EOF
          Origin: Jailbreak Detector Repo
          Label: Jailbreak Detector
          Suite: stable
          Version: 1.0
          Codename: ios
          Architectures: iphoneos-arm iphoneos-arm64
          Components: main
          Description: Official repository for Jailbreak Detector
          Date: $(date -u '+%a, %d %b %Y %H:%M:%S %z')
          MD5Sum:
          EOF
          
          # Add checksums
          for file in Packages Packages.gz Packages.bz2; do
            if [ -f "$file" ]; then
              echo " $(md5 -q $file | cut -d ' ' -f1) $(wc -c < $file | xargs) $file" >> Release
            fi
          done
          
          # Commit and Push using git directly
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Update repo for release ${{ steps.version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin gh-pages
