name: Build Debian Package

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          brew install dpkg ldid
      
      - name: Build app
        run: |
          xcodebuild archive \
            -project JailbreakDetector.xcodeproj \
            -scheme JailbreakDetector \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/JailbreakDetector.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Fake sign with ldid
        run: |
          APP_PATH="build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app"
          
          # Sign Widget Extension if exists
          if [ -d "$APP_PATH/PlugIns" ]; then
            for EXT in "$APP_PATH/PlugIns"/*.appex; do
              if [ -d "$EXT" ]; then
                EXT_BINARY="$EXT/$(basename "$EXT" .appex)"
                ldid -SJailbreakDetector/JailbreakWidget/JailbreakWidget.entitlements "$EXT_BINARY" 2>/dev/null || ldid -S "$EXT_BINARY"
                echo "✅ Signed: $(basename "$EXT")"
              fi
            done
          fi
          
          # Sign Main App
          BINARY="$APP_PATH/JailbreakDetectorApp"
          ldid -SJailbreakDetector/JailbreakDetector/JailbreakDetector.entitlements "$BINARY"
          echo "✅ Signed main app"
      
      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create .deb packages for both architectures
        run: |
          # Build for iphoneos-arm
          mkdir -p package-arm/DEBIAN
          mkdir -p package-arm/Applications
          cp -R build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app \
            package-arm/Applications/JailbreakDetector.app
          
          cat > package-arm/DEBIAN/control << EOF
          Package: com.security.jailbreakdetector
          Name: Jailbreak Detector
          Version: ${{ steps.version.outputs.VERSION }}
          Architecture: iphoneos-arm
          Description: Advanced jailbreak detection with 8 techniques (OWASP MSTG compliant)
          Homepage: https://github.com/betillogalvanfbc/jailbreakdetection
          Maintainer: Developer
          Author: Developer
          Section: Security
          Depends: firmware (>= 16.0)
          EOF
          
          cat > package-arm/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          uicache -a
          exit 0
          EOF
          chmod 755 package-arm/DEBIAN/postinst
          
          # Build for iphoneos-arm64
          mkdir -p package-arm64/DEBIAN
          mkdir -p package-arm64/Applications
          cp -R build/JailbreakDetector.xcarchive/Products/Applications/JailbreakDetectorApp.app \
            package-arm64/Applications/JailbreakDetector.app
          
          cat > package-arm64/DEBIAN/control << EOF
          Package: com.security.jailbreakdetector
          Name: Jailbreak Detector
          Version: ${{ steps.version.outputs.VERSION }}
          Architecture: iphoneos-arm64
          Description: Advanced jailbreak detection with 8 techniques (OWASP MSTG compliant)
          Homepage: https://github.com/betillogalvanfbc/jailbreakdetection
          Maintainer: Developer
          Author: Developer
          Section: Security
          Depends: firmware (>= 16.0)
          EOF
          
          cat > package-arm64/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          uicache -a
          exit 0
          EOF
          chmod 755 package-arm64/DEBIAN/postinst
      
      - name: Build .deb packages
        run: |
          # Build iphoneos-arm
          dpkg-deb -b package-arm jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb
          echo "=== iphoneos-arm .deb info ==="
          dpkg-deb -I jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb
          
          # Build iphoneos-arm64
          dpkg-deb -b package-arm64 jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb
          echo "=== iphoneos-arm64 .deb info ==="
          dpkg-deb -I jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb
      
      - name: Upload both .deb packages to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ steps.version.outputs.VERSION }} \
            jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm.deb \
            jailbreakdetector_${{ steps.version.outputs.VERSION }}_iphoneos-arm64.deb \
            --clobber
